<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Quest 1</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  margin: 0;
  font-family: serif;
  color: #f5f5f5;
  background-position: center center;  
  background-size: cover;  
  background-attachment: fixed;  
  background-repeat: no-repeat; 
}
#sceneImage {
  width: 100%;
  border-radius: 8px;
  margin-bottom: 20px;
  display: none;
}
.overlay {
  min-height: 100vh;
  background: rgba(0,0,0,0.7);
  display: flex;
}

#quest {
  max-width: 800px;
  margin: auto;
  padding: 30px;
  background: rgba(20,20,20,0.9);
  border-radius: 10px;
}

button {
  background: #2c3e50;
  color: #fff;
  border: none;
  padding: 12px;
  margin: 8px 0;
  width: 100%;
  cursor: pointer;
  border-radius: 6px;
}

button:hover {
  background: #3f5873;
}

input {
  padding: 8px;
  width: 100px;
}

#map {
  position: fixed;
  right: 0;
  top: 0;
  background: #111;
  color: #ccc;
  padding: 10px;
  max-height: 100vh;
  overflow: auto;
  font-size: 0.8em;
}
.active {
  color: #fff;
  font-weight: bold;
}
.locked {
  color: #555;
}
</style>
</head>

<body>
<div class="overlay">
  <div id="quest">
    <img id="sceneImage">
    <div id="text"></div>

    <div id="controls"></div>
  </div>
</div>

<div id="map"></div>

<script>
let story = {};
let currentScene = null;
let flags = new Set();

function switchMap(data){
  let isVisible = data;
  const block = document.getElementById("map");

  if (isVisible) {
    block.style.display = "block";
  } else {
    block.style.display = "none";
  }
}
mapa = false
document.addEventListener("keydown", function (event) {
  if (event.metaKey && event.key === "s") {
    event.preventDefault();
    mapa = mapa ? false : true
    switchMap(mapa);
  }
});

switchMap(mapa);

function changeBackgroundImage(number) {
            url = 'url("images' + number + '/bg.jpg")'
            document.body.style.backgroundImage = url
}
/* ===== ЗАГРУЗКА КВЕСТА ===== */
async function loadQuest() {
  var params = window
    .location
    .search
    .replace('?','').split('=');
  urlQuest = 'quest' + decodeURIComponent(params[1]) + '.json'
  changeBackgroundImage(decodeURIComponent(params[1]))
  const res = await fetch(urlQuest);
  const data = await res.json();
  story = data.scenes;
  showScene(data.start);
  renderMap();
}

/* ===== ПРОВЕРКА УСЛОВИЙ ===== */
function checkRequires(req = []) {
  return req.every(r => flags.has(r));
}

/* ===== ПОКАЗ СЦЕНЫ ===== */
function showScene(id) {
  const scene = story[id];
  if (!scene || !checkRequires(scene.requires || [])) return;

  currentScene = id;

  if (scene.sets) {
    scene.sets.forEach(f => flags.add(f));
  }

  document.getElementById("text").innerText = scene.text;
  const img = document.getElementById("sceneImage");
  if (scene.image) {
    img.src = scene.image;
    img.style.display = "block";
  } else {
    img.style.display = "none";
  }
  const controls = document.getElementById("controls");
  controls.innerHTML = "";

  if (scene.choices) {
    scene.choices.forEach(c => {
      if (!checkRequires(c.requires || [])) return;

      const btn = document.createElement("button");
      btn.innerText = c.text;

      btn.onclick = () => {
        if (c.dice) {
          renderDice(c.dice);
        } else {
          showScene(c.next);
        }
      };

      controls.appendChild(btn);
    });
  } else if (scene.dice) {
    renderDice(scene.dice);
  } else if (scene.next) {
    const btn = document.createElement("button");
    btn.innerText = "Продолжить";
    btn.onclick = () => showScene(scene.next);
    controls.appendChild(btn);
  }

  renderMap();
}

/* ===== ДАЙС ===== */
function renderDice(dice) {
  const controls = document.getElementById("controls");
  controls.innerHTML = `
    <p>Введите число:</p>
    <input type="number" id="diceInput">
    <button id="diceBtn">Продолжить</button>
  `;

  document.getElementById("diceBtn").onclick = () => {
    const v = parseInt(document.getElementById("diceInput").value);
    for (let r of dice.results) {
      if (v >= r.from && v <= r.to) {
        showScene(r.next);
        return;
      }
    }
  };
}

/* ===== КАРТА СЦЕН ===== */
function renderMap() {
  const map = document.getElementById("map");
  map.innerHTML = "<b>Карта сцен</b><br>";

  for (let id in story) {
    const scene = story[id];
    let cls = "";
    if (id === currentScene) cls = "active";
    else if (scene.requires && !checkRequires(scene.requires)) cls = "locked";

    map.innerHTML += `<div class="${cls}">${id}</div>`;
  }

  map.innerHTML += `<hr><b>Флаги:</b><br>${[...flags].join(", ")}`;
}


/* ===== СТАРТ ===== */
loadQuest();
</script>
</body>
</html>
